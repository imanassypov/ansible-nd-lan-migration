---
# Playbook: 1.0-preprovision-new-switches.yml
# Purpose: Pre-provision new switches to NDFC via POAP API or discover existing switches
#
# Description:
#   This playbook adds switches to Nexus Dashboard Fabric Controller by:
#   1. Loading switch_details.yml to get current serial numbers
#   2. Comparing destination_switch_sn (hosts.yml) with serial_number (switch_details.yml):
#      - Match: Discover existing switch via Manage API (same hardware)
#      - Mismatch: Pre-provision new switch via POAP API (replacement hardware)
#
# Variables Required (per switch in hosts.yml):
#   - add_to_fabric: Set to true to include switch in provisioning
#   - fabric: Target fabric name
#   - role: Switch role (access, aggregation, etc.)
#   - ansible_host: Target switch management IP address
#   - destination_switch_sn: Target switch serial number (compared against switch_details.yml)
#
# For POAP Pre-provisioning (destination_switch_sn != switch_details serial):
#   - destination_switch_model: Target switch model (e.g., N9K-C9300v)
#   - destination_switch_version: Target NX-OS version (e.g., 10.6(1))
#
# For Discovery (destination_switch_sn == switch_details serial):
#   - No additional variables required beyond destination_switch_sn
#
# Variables from static_routes.yml:
#   - switches.<hostname>.routes: List of static routes including default gateway
#
# Variables from l3_interfaces.yml:
#   - switches.<hostname>.interfaces: L3 interface configurations with IP addresses
#
# API Endpoints Used:
#   - POST /appcenter/cisco/ndfc/api/v1/lan-fabric/rest/control/fabrics/<fabric>/inventory/poap (POAP)
#   - POST /api/v1/manage/fabrics/<fabric>/switches (Discovery)
#
# Templates Used:
#   - 1.0-preprovision-new-switches.j2: Jinja2 template for POAP API JSON payload
#
# Tags:
#   - preprovision-switches: Run only switch pre-provisioning tasks
#   - discover-switches: Run only switch discovery tasks
#
# Example Usage:
#   ansible-playbook ./playbooks/1.0-preprovision-new-switches.yml
#   ansible-playbook ./playbooks/1.0-preprovision-new-switches.yml --tags preprovision-switches
#   ansible-playbook ./playbooks/1.0-preprovision-new-switches.yml --tags discover-switches

- name: Pre-provision New Switches to NDFC
  hosts: nexus_dashboard
  gather_facts: false

  tags:
    - preprovision-switches
    - discover-switches

  tasks:

    #--------------------------------------------------------------------------
    # Pre-flight: Verify NDFC is reachable before any provisioning
    #--------------------------------------------------------------------------
    - name: Verify NDFC connectivity
      ansible.builtin.import_tasks: ../common/ndfc-preflight-check.yml

    # Build list of switches to pre-provision from inventory
    - name: Build list of switches to pre-provision
      ansible.builtin.set_fact:
        switches_to_preprovision: >-
          {{
            groups['switches'] | default([])
            | map('extract', hostvars)
            | selectattr('add_to_fabric', 'defined')
            | selectattr('add_to_fabric', 'equalto', true)
            | list
          }}

    #--------------------------------------------------------------------------
    # Load switch_details.yml for workflow classification
    # Compare destination_switch_sn (hosts.yml) with serial_number (switch_details.yml):
    #   - Match    → Discovery workflow (existing switch, same hardware)
    #   - Mismatch → POAP pre-provisioning workflow (new switch replacing old)
    #--------------------------------------------------------------------------
    - name: Find switch_details.yml files for workflow classification
      ansible.builtin.find:
        paths: "{{ playbook_dir }}/../../fabrics"
        patterns: "switch_details.yml"
        recurse: true
      register: switch_details_files_early
      delegate_to: localhost
      when: switches_to_preprovision | length > 0

    - name: Load switch details for workflow classification
      ansible.builtin.include_vars:
        file: "{{ item.path }}"
        name: "switch_details_early_{{ item.path | dirname | basename | replace('-', '_') }}"
      loop: "{{ switch_details_files_early.files | default([]) }}"
      loop_control:
        label: "{{ item.path | dirname | basename }}"
      when: switches_to_preprovision | length > 0

    - name: Build switch details lookup by IP for workflow classification
      ansible.builtin.set_fact:
        switch_details_by_ip: |
          {%- set lookup = {} -%}
          {%- for var_name in hostvars[inventory_hostname] | select('match', '^switch_details_early_') -%}
            {%- set details = hostvars[inventory_hostname][var_name] -%}
            {%- if details.switches is defined -%}
              {%- for sw in details.switches -%}
                {%- set _ = lookup.update({sw.ip_address: sw}) -%}
              {%- endfor -%}
            {%- endif -%}
          {%- endfor -%}
          {{ lookup }}
      when: switches_to_preprovision | length > 0

    # Separate switches into POAP (serial mismatch) and Discovery (serial match)
    # destination_switch_sn matches switch_details serial_number → Discovery
    # destination_switch_sn does NOT match switch_details serial_number → POAP
    - name: Separate switches by provisioning method
      ansible.builtin.set_fact:
        switches_for_poap: |
          {%- set poap_list = [] -%}
          {%- for switch in switches_to_preprovision -%}
            {%- set dest_sn = switch.destination_switch_sn | default('') -%}
            {%- set ip = switch.ansible_host | default('') -%}
            {%- set details = switch_details_by_ip.get(ip, {}) if switch_details_by_ip is defined else {} -%}
            {%- set current_sn = details.get('serial_number', '') -%}
            {%- if dest_sn and current_sn and dest_sn != current_sn
                and switch.destination_switch_model is defined
                and switch.destination_switch_version is defined -%}
              {%- set _ = poap_list.append(switch) -%}
            {%- endif -%}
          {%- endfor -%}
          {{ poap_list }}
        switches_for_discovery: |
          {%- set disc_list = [] -%}
          {%- for switch in switches_to_preprovision -%}
            {%- set dest_sn = switch.destination_switch_sn | default('') -%}
            {%- set ip = switch.ansible_host | default('') -%}
            {%- set details = switch_details_by_ip.get(ip, {}) if switch_details_by_ip is defined else {} -%}
            {%- set current_sn = details.get('serial_number', '') -%}
            {%- if not dest_sn or not current_sn or dest_sn == current_sn -%}
              {%- set _ = disc_list.append(switch) -%}
            {%- endif -%}
          {%- endfor -%}
          {{ disc_list }}
      when: switches_to_preprovision | length > 0

    - name: Display workflow classification
      ansible.builtin.debug:
        msg: |
          ═══════════════════════════════════════════════════════════════════════
          WORKFLOW CLASSIFICATION (destination_switch_sn vs switch_details serial)
          ═══════════════════════════════════════════════════════════════════════
          POAP Pre-provisioning (serial mismatch - new hardware): {{ switches_for_poap | length }}
          {% for sw in switches_for_poap %}
          - {{ sw.inventory_hostname }}: destination_sn={{ sw.destination_switch_sn }} ≠ switch_details_sn={{ switch_details_by_ip.get(sw.ansible_host, {}).get('serial_number', 'N/A') }}
          {% endfor %}
          Discovery (serial match - existing hardware): {{ switches_for_discovery | length }}
          {% for sw in switches_for_discovery %}
          {%- set dest_sn = sw.destination_switch_sn | default('N/A') -%}
          {%- set current_sn = switch_details_by_ip.get(sw.ansible_host, {}).get('serial_number', 'N/A') -%}
          - {{ sw.inventory_hostname }}: destination_sn={{ dest_sn }}, switch_details_sn={{ current_sn }}
          {% endfor %}
          ═══════════════════════════════════════════════════════════════════════
      when: switches_to_preprovision | length > 0

    #--------------------------------------------------------------------------
    # Load static routes data for gateway info
    #--------------------------------------------------------------------------
    - name: Find all static_routes.yml files
      ansible.builtin.find:
        paths: "{{ playbook_dir }}/../../fabrics"
        patterns: "static_routes.yml"
        recurse: true
      register: static_routes_files
      when: switches_to_preprovision | length > 0

    - name: Load static routes data from all fabrics
      ansible.builtin.include_vars:
        file: "{{ item.path }}"
        name: "routes_data_{{ item.path | dirname | basename }}"
      loop: "{{ static_routes_files.files | default([]) }}"
      loop_control:
        label: "{{ item.path | dirname | basename }}"
      when: switches_to_preprovision | length > 0

    - name: Build consolidated static routes lookup
      ansible.builtin.set_fact:
        static_routes_lookup: |
          {%- set lookup = {} -%}
          {%- for file in static_routes_files.files | default([]) -%}
            {%- set fabric_name = file.path | dirname | basename -%}
            {%- set var_name = 'routes_data_' + fabric_name -%}
            {%- if hostvars[inventory_hostname][var_name] is defined -%}
              {%- set fabric_data = hostvars[inventory_hostname][var_name] -%}
              {%- if fabric_data.switches is defined -%}
                {%- for hostname, data in fabric_data.switches.items() -%}
                  {%- set _ = lookup.update({hostname: data | combine({'fabric': fabric_name})}) -%}
                {%- endfor -%}
              {%- endif -%}
            {%- endif -%}
          {%- endfor -%}
          {{ lookup }}
      when: switches_to_preprovision | length > 0

    #--------------------------------------------------------------------------
    # Load L3 interface data for management IP prefix
    #--------------------------------------------------------------------------
    - name: Find all l3_interfaces.yml files
      ansible.builtin.find:
        paths: "{{ playbook_dir }}/../../fabrics"
        patterns: "l3_interfaces.yml"
        recurse: true
      register: l3_interfaces_files
      when: switches_to_preprovision | length > 0

    - name: Load L3 interface data from all fabrics
      ansible.builtin.include_vars:
        file: "{{ item.path }}"
        name: "l3_data_{{ item.path | dirname | basename }}"
      loop: "{{ l3_interfaces_files.files | default([]) }}"
      loop_control:
        label: "{{ item.path | dirname | basename }}"
      when: switches_to_preprovision | length > 0

    - name: Build consolidated L3 interfaces lookup
      ansible.builtin.set_fact:
        l3_interfaces_lookup: |
          {%- set lookup = {} -%}
          {%- for file in l3_interfaces_files.files | default([]) -%}
            {%- set fabric_name = file.path | dirname | basename -%}
            {%- set var_name = 'l3_data_' + fabric_name -%}
            {%- if hostvars[inventory_hostname][var_name] is defined -%}
              {%- set fabric_data = hostvars[inventory_hostname][var_name] -%}
              {%- if fabric_data.switches is defined -%}
                {%- for hostname, data in fabric_data.switches.items() -%}
                  {%- set _ = lookup.update({hostname: {'interfaces': data.interfaces | default([]), 'fabric': fabric_name}}) -%}
                {%- endfor -%}
              {%- endif -%}
            {%- endif -%}
          {%- endfor -%}
          {{ lookup }}
      when: switches_to_preprovision | length > 0

    # Build pre-provision profiles for each switch
    - name: Build pre-provision profiles
      ansible.builtin.set_fact:
        preprovision_profiles: |
          {%- set profiles = [] -%}
          {%- for switch in switches_to_preprovision -%}
            {%- set hostname = switch.inventory_hostname -%}
            {%- set mgmt_int = switch.mgmt_int | default('Vlan199') -%}
            {%- if switch.destination_switch_sn is defined and 
                   switch.destination_switch_model is defined and
                   switch.destination_switch_version is defined and
                   switch.ansible_host is defined -%}
              {# Get default route from static_routes_lookup #}
              {%- set routes_data = static_routes_lookup.get(hostname, {}) -%}
              {%- set all_default_routes = routes_data.routes | default([]) | selectattr('prefix', 'equalto', '0.0.0.0/0') | list -%}
              {# Filter for routes with matching interface, handling missing interface attribute #}
              {%- set matching_routes = [] -%}
              {%- for route in all_default_routes -%}
                {%- if route.interface is defined and route.interface == mgmt_int -%}
                  {%- set _ = matching_routes.append(route) -%}
                {%- endif -%}
              {%- endfor -%}
              {# Fallback to any default route if no interface-specific route found #}
              {%- set default_route = matching_routes | first | default(all_default_routes | first | default({})) -%}
              {%- set gateway_ip = default_route.next_hop | default('') -%}
              {# Get management interface prefix from l3_interfaces_lookup #}
              {%- set l3_data = l3_interfaces_lookup.get(hostname, {}) -%}
              {%- set mgmt_iface = l3_data.interfaces | default([]) | selectattr('name', 'equalto', mgmt_int) | list | first | default({}) -%}
              {%- set mgmt_ip = mgmt_iface.ipv4_address | default('') -%}
              {%- set gateway_prefix = mgmt_ip.split('/')[1] | default('24') if mgmt_ip else '24' -%}
              {%- set gateway = gateway_ip + '/' + gateway_prefix if gateway_ip else '' -%}
              {%- set profile = {
                'fabric': switch.fabric,
                'hostname': hostname,
                'serial_number': switch.destination_switch_sn,
                'model': switch.destination_switch_model,
                'version': switch.destination_switch_version,
                'ip_address': switch.ansible_host,
                'role': switch.role,
                'gateway': gateway
              } -%}
              {%- set _ = profiles.append(profile) -%}
            {%- endif -%}
          {%- endfor -%}
          {{ profiles }}
      when: switches_to_preprovision | length > 0

    # Group profiles by fabric for batch API calls
    - name: Group pre-provision profiles by fabric
      ansible.builtin.set_fact:
        preprovision_by_fabric: |
          {%- set by_fabric = {} -%}
          {%- for profile in preprovision_profiles -%}
            {%- if profile.fabric not in by_fabric -%}
              {%- set _ = by_fabric.update({profile.fabric: []}) -%}
            {%- endif -%}
            {%- set _ = by_fabric[profile.fabric].append(profile) -%}
          {%- endfor -%}
          {{ by_fabric }}
      when: 
        - switches_to_preprovision | length > 0
        - preprovision_profiles | length > 0

    # Query existing pre-provisioned switches to make playbook idempotent
    - name: Query existing switches in each fabric
      cisco.nd.nd_rest:
        host: "{{ ansible_host }}"
        username: "{{ ansible_user }}"
        password: "{{ ansible_ssh_pass }}"
        use_ssl: "{{ ansible_httpapi_use_ssl }}"
        validate_certs: "{{ ansible_httpapi_validate_certs }}"
        use_proxy: "{{ ansible_httpapi_use_proxy }}"
        login_domain: "{{ ansible_httpapi_login_domain }}"
        path: "/appcenter/cisco/ndfc/api/v1/lan-fabric/rest/control/fabrics/{{ item }}/inventory"
        method: GET
      loop: "{{ preprovision_by_fabric.keys() | list }}"
      loop_control:
        label: "{{ item }}"
      when:
        - preprovision_by_fabric is defined
        - preprovision_by_fabric | length > 0
      register: existing_switches_query

    - name: Build set of existing switch serial numbers
      ansible.builtin.set_fact:
        existing_switch_serials: |
          {%- set serials = [] -%}
          {%- for result in existing_switches_query.results | default([]) -%}
            {%- if result.current is defined and result.current is iterable -%}
              {%- for switch in result.current -%}
                {%- if switch.serialNumber is defined -%}
                  {%- set _ = serials.append(switch.serialNumber) -%}
                {%- endif -%}
              {%- endfor -%}
            {%- endif -%}
          {%- endfor -%}
          {{ serials }}
      when: existing_switches_query is defined

    - name: Filter out already pre-provisioned switches
      ansible.builtin.set_fact:
        preprovision_by_fabric_filtered: |
          {%- set filtered = {} -%}
          {%- for fabric, switches in preprovision_by_fabric.items() -%}
            {%- set new_switches = [] -%}
            {%- for sw in switches -%}
              {%- if sw.serial_number not in existing_switch_serials -%}
                {%- set _ = new_switches.append(sw) -%}
              {%- endif -%}
            {%- endfor -%}
            {%- if new_switches | length > 0 -%}
              {%- set _ = filtered.update({fabric: new_switches}) -%}
            {%- endif -%}
          {%- endfor -%}
          {{ filtered }}
      when: preprovision_by_fabric is defined

    - name: Display switches to pre-provision (after filtering existing)
      ansible.builtin.debug:
        msg: |
          Switches to pre-provision (excluding existing): {{ preprovision_by_fabric_filtered | dict2items | map(attribute='value') | flatten | length }}
          Already pre-provisioned: {{ existing_switch_serials | length }}
          {% for fabric, switches in preprovision_by_fabric_filtered.items() %}
          - {{ fabric }}: {% for sw in switches %}{{ sw.hostname }}{% if not loop.last %}, {% endif %}{% endfor %}
          {% endfor %}
      when: preprovision_by_fabric_filtered is defined

    # Pre-provision switches to NDFC via POAP API
    - name: Build POAP payloads per fabric
      ansible.builtin.set_fact:
        poap_payloads: |
          {%- set payloads = {} -%}
          {%- for fabric, switches in preprovision_by_fabric_filtered.items() -%}
            {%- set switch_list = [] -%}
            {%- for switch in switches -%}
              {%- set entry = {
                "serialNumber": switch.serial_number,
                "model": switch.model,
                "version": switch.version,
                "hostname": switch.hostname,
                "ipAddress": switch.ip_address,
                "password": nd_switch_password,
                "discoveryAuthProtocol": 0,
                "data": '{"modulesModel": ["' ~ switch.model ~ '"], "gateway": "' ~ switch.gateway ~ '"}',
                "imagePolicy": "",
                "role": switch.role
              } -%}
              {%- set _ = switch_list.append(entry) -%}
            {%- endfor -%}
            {%- set _ = payloads.update({fabric: switch_list}) -%}
          {%- endfor -%}
          {{ payloads }}
      when:
        - preprovision_by_fabric_filtered is defined
        - preprovision_by_fabric_filtered | length > 0

    - name: Pre-provision switches to NDFC
      cisco.nd.nd_rest:
        host: "{{ ansible_host }}"
        username: "{{ ansible_user }}"
        password: "{{ ansible_ssh_pass }}"
        use_ssl: "{{ ansible_httpapi_use_ssl }}"
        validate_certs: "{{ ansible_httpapi_validate_certs }}"
        use_proxy: "{{ ansible_httpapi_use_proxy }}"
        login_domain: "{{ ansible_httpapi_login_domain }}"
        path: "/appcenter/cisco/ndfc/api/v1/lan-fabric/rest/control/fabrics/{{ item.key }}/inventory/poap"
        method: POST
        content: "{{ item.value | to_json }}"
      loop: "{{ poap_payloads | dict2items }}"
      loop_control:
        label: "{{ item.key }} ({{ item.value | length }} switches)"
      when:
        - poap_payloads is defined
        - poap_payloads | length > 0
      register: preprovision_results

    - name: Display pre-provisioning results
      ansible.builtin.debug:
        msg: |
          Pre-provisioning complete.
          Already existed (skipped): {{ existing_switch_serials | length }}
          {% for result in preprovision_results.results | default([]) %}
          {% if result.skipped is not defined or not result.skipped %}
          - {{ result.item.key }}: {{ 'SUCCESS' if result.failed is not defined or not result.failed else 'FAILED' }}
            Switches: {% for sw in result.item.value %}{{ sw.hostname }}{% if not loop.last %}, {% endif %}{% endfor %}
          {% endif %}
          {% endfor %}
      when: preprovision_results is defined

    # Capture POAP switch hostnames to exclude from role assignment
    # POAP switches already have roles assigned during pre-provisioning
    - name: Build list of POAP switch hostnames
      ansible.builtin.set_fact:
        poap_switch_hostnames: |
          {%- set hostnames = [] -%}
          {%- for profile in preprovision_profiles | default([]) -%}
            {%- if profile.hostname is defined -%}
              {%- set _ = hostnames.append(profile.hostname) -%}
            {%- endif -%}
          {%- endfor -%}
          {{ hostnames }}
      when: preprovision_profiles is defined

    - name: Display POAP switches excluded from role assignment
      ansible.builtin.debug:
        msg: |
          POAP switches (role already assigned during pre-provisioning): {{ poap_switch_hostnames | length }}
          Hostnames: {{ poap_switch_hostnames | join(', ') if poap_switch_hostnames | length > 0 else 'None' }}
      when: poap_switch_hostnames is defined and poap_switch_hostnames | length > 0

    #==========================================================================
    # DISCOVERY WORKFLOW - For existing switches without destination_switch_sn
    #==========================================================================

    # Load switch_details.yml to get serial numbers for discovery and role assignment
    - name: Find switch_details.yml files for discovery
      ansible.builtin.find:
        paths: "../../fabrics"
        patterns: "switch_details.yml"
        recurse: true
      register: switch_details_files
      delegate_to: localhost
      tags:
        - discover-switches
        - assign-roles

    - name: Load switch details from all fabrics for discovery
      ansible.builtin.include_vars:
        file: "{{ item.path }}"
        name: "switch_details_{{ item.path | dirname | basename }}"
      loop: "{{ switch_details_files.files | default([]) }}"
      loop_control:
        label: "{{ item.path | dirname | basename }}"
      when: switch_details_files.files is defined and switch_details_files.files | length > 0
      tags:
        - discover-switches
        - assign-roles

    - name: Build consolidated switch details lookup
      ansible.builtin.set_fact:
        switch_details_lookup: |
          {%- set lookup = {} -%}
          {%- for fabric_file in switch_details_files.files | default([]) -%}
            {%- set fabric_name = fabric_file.path | dirname | basename -%}
            {%- set var_name = 'switch_details_' ~ fabric_name -%}
            {%- if hostvars[inventory_hostname][var_name] is defined -%}
              {%- set details = hostvars[inventory_hostname][var_name] -%}
              {%- if details.switches is defined -%}
                {%- for sw in details.switches -%}
                  {%- set sw_with_fabric = sw | combine({'fabric': fabric_name}) -%}
                  {%- set _ = lookup.update({sw.ip_address: sw_with_fabric}) -%}
                {%- endfor -%}
              {%- endif -%}
            {%- endif -%}
          {%- endfor -%}
          {{ lookup }}
      when: switch_details_files.files is defined and switch_details_files.files | length > 0
      tags:
        - discover-switches
        - assign-roles

    # Build discovery profiles for switches without serial numbers
    - name: Build discovery profiles
      ansible.builtin.set_fact:
        discovery_profiles: |
          {%- set profiles = [] -%}
          {%- for switch in switches_for_discovery | default([]) -%}
            {%- set hostname = switch.inventory_hostname -%}
            {%- if switch.ansible_host is defined and switch.fabric is defined -%}
              {%- set details = switch_details_lookup.get(switch.ansible_host, {}) if switch_details_lookup is defined else {} -%}
              {%- set profile = {
                'fabric': switch.fabric,
                'hostname': hostname,
                'ip_address': switch.ansible_host,
                'role': switch.role | default('access'),
                'serial_number': details.get('license_hostid', ''),
                'model': details.get('model', ''),
                'software_version': details.get('software_version', '')
              } -%}
              {%- set _ = profiles.append(profile) -%}
            {%- endif -%}
          {%- endfor -%}
          {{ profiles }}
      when: switches_for_discovery is defined and switches_for_discovery | length > 0
      tags:
        - discover-switches

    # Group discovery profiles by fabric
    - name: Group discovery profiles by fabric
      ansible.builtin.set_fact:
        discovery_by_fabric: |
          {%- set by_fabric = {} -%}
          {%- for profile in discovery_profiles -%}
            {%- if profile.fabric not in by_fabric -%}
              {%- set _ = by_fabric.update({profile.fabric: []}) -%}
            {%- endif -%}
            {%- set _ = by_fabric[profile.fabric].append(profile) -%}
          {%- endfor -%}
          {{ by_fabric }}
      when:
        - discovery_profiles is defined
        - discovery_profiles | length > 0
      tags:
        - discover-switches

    # Query existing managed switches to filter out already discovered
    - name: Query existing managed switches for discovery
      cisco.nd.nd_rest:
        host: "{{ ansible_host }}"
        username: "{{ ansible_user }}"
        password: "{{ ansible_ssh_pass }}"
        use_ssl: "{{ ansible_httpapi_use_ssl }}"
        validate_certs: "{{ ansible_httpapi_validate_certs }}"
        use_proxy: "{{ ansible_httpapi_use_proxy }}"
        login_domain: "{{ ansible_httpapi_login_domain }}"
        path: "/appcenter/cisco/ndfc/api/v1/lan-fabric/rest/control/fabrics/{{ item }}/inventory"
        method: GET
      loop: "{{ discovery_by_fabric.keys() | list }}"
      loop_control:
        label: "{{ item }}"
      when:
        - discovery_by_fabric is defined
        - discovery_by_fabric | length > 0
      register: existing_managed_query
      ignore_errors: true
      tags:
        - discover-switches

    - name: Build set of existing managed switch IPs
      ansible.builtin.set_fact:
        existing_managed_ips: |
          {%- set ips = [] -%}
          {%- for result in existing_managed_query.results | default([]) -%}
            {%- if result.current is defined and result.current is iterable -%}
              {%- for switch in result.current -%}
                {%- if switch.ipAddress is defined -%}
                  {%- set _ = ips.append(switch.ipAddress) -%}
                {%- endif -%}
              {%- endfor -%}
            {%- endif -%}
          {%- endfor -%}
          {{ ips }}
      when: existing_managed_query is defined
      tags:
        - discover-switches

    - name: Filter out already managed switches
      ansible.builtin.set_fact:
        discovery_by_fabric_filtered: |
          {%- set filtered = {} -%}
          {%- for fabric, switches in discovery_by_fabric.items() -%}
            {%- set new_switches = [] -%}
            {%- for sw in switches -%}
              {%- if sw.ip_address not in existing_managed_ips -%}
                {%- set _ = new_switches.append(sw) -%}
              {%- endif -%}
            {%- endfor -%}
            {%- if new_switches | length > 0 -%}
              {%- set _ = filtered.update({fabric: new_switches}) -%}
            {%- endif -%}
          {%- endfor -%}
          {{ filtered }}
      when: discovery_by_fabric is defined
      tags:
        - discover-switches

    - name: Display switches to discover (after filtering existing)
      ansible.builtin.debug:
        msg: |
          ═══════════════════════════════════════════════════════════════════════
          SWITCH DISCOVERY
          ═══════════════════════════════════════════════════════════════════════
          Switches to discover (excluding existing): {{ discovery_by_fabric_filtered | dict2items | map(attribute='value') | flatten | length }}
          Already preprovisioned: {{ existing_managed_ips | default([]) | length }}
          {% for fabric, switches in discovery_by_fabric_filtered.items() %}
          - {{ fabric }}: {% for sw in switches %}{{ sw.hostname }} ({{ sw.ip_address }}, SN: {{ sw.serial_number | default('N/A') }}){% if not loop.last %}, {% endif %}{% endfor %}
          {% endfor %}
          ═══════════════════════════════════════════════════════════════════════
      when: discovery_by_fabric_filtered is defined
      tags:
        - discover-switches

    # Discover switches to NDFC via Manage API
    # Uses the switches array format required by the API
    # Note: Discovery is a long-running operation, timeout extended to 300s
    - name: Discover existing switches to NDFC
      cisco.nd.nd_rest:
        host: "{{ ansible_host }}"
        username: "{{ ansible_user }}"
        password: "{{ ansible_ssh_pass }}"
        use_ssl: "{{ ansible_httpapi_use_ssl }}"
        validate_certs: "{{ ansible_httpapi_validate_certs }}"
        use_proxy: "{{ ansible_httpapi_use_proxy }}"
        login_domain: "{{ ansible_httpapi_login_domain }}"
        timeout: 300
        path: "/api/v1/manage/fabrics/{{ item.key }}/switches"
        method: POST
        content:
          snmpV3AuthProtocol: "{{ snmp_v3_auth_protocol | default('md5') }}"
          username: "{{ vault_nd_discovery_user }}"
          password: "{{ vault_nd_discovery_password }}"
          preserveConfig: "{{ preserve_config | default(true) | bool }}"
          useCredentialForWrite: "{{ use_credential_for_write | default(false) | bool }}"
          switches: >-
            {%- set switch_list = [] -%}
            {%- for sw in item.value -%}
              {%- set switch_entry = {
                'ip': sw.ip_address,
                'hostname': sw.hostname,
                'model': sw.model | default(''),
                'softwareVersion': sw.software_version | default(''),
                'serialNumber': sw.serial_number | default(''),
                'vdcId': 0,
                'vdcMac': ''
              } -%}
              {%- set _ = switch_list.append(switch_entry) -%}
            {%- endfor -%}
            {{ switch_list }}
      loop: "{{ discovery_by_fabric_filtered | dict2items }}"
      loop_control:
        label: "{{ item.key }} ({{ item.value | length }} switches)"
      when:
        - discovery_by_fabric_filtered is defined
        - discovery_by_fabric_filtered | length > 0
      register: discovery_results
      tags:
        - discover-switches

    - name: Display discovery results
      ansible.builtin.debug:
        msg: |
          ═══════════════════════════════════════════════════════════════════════
          DISCOVERY RESULTS
          ═══════════════════════════════════════════════════════════════════════
          Already preprovisioned (skipped): {{ existing_managed_ips | default([]) | length }}
          {% for result in discovery_results.results | default([]) %}
          {% if result.skipped is not defined or not result.skipped %}
          - {{ result.item.key }}: {{ 'SUCCESS' if result.failed is not defined or not result.failed else 'FAILED' }}
            Switches: {% for sw in result.item.value %}{{ sw.hostname }}{% if not loop.last %}, {% endif %}{% endfor %}
          {% endif %}
          {% endfor %}
          ═══════════════════════════════════════════════════════════════════════
      when: discovery_results is defined
      tags:
        - discover-switches

    #==========================================================================
    # SWITCH ROLE ASSIGNMENT - Set switch roles based on hosts.yml inventory
    #==========================================================================

    # Build role assignment list from inventory (hosts.yml)
    # Serial numbers: use destination_switch_sn for POAP switches, switch_details_lookup for discovered switches
    - name: Build switch role assignments
      ansible.builtin.set_fact:
        switch_role_assignments: |
          {%- set assignments = [] -%}
          {%- for switch in switches_to_preprovision | default([]) -%}
            {%- set hostname = switch.inventory_hostname -%}
            {%- set ip = switch.ansible_host | default('') -%}
            {# For pre-provisioned switches, use destination_switch_sn directly #}
            {%- if switch.destination_switch_sn is defined -%}
              {%- set serial = switch.destination_switch_sn -%}
            {%- else -%}
              {# For discovered switches, look up serial from switch_details #}
              {%- set details = switch_details_lookup.get(ip, {}) if switch_details_lookup is defined else {} -%}
              {%- set serial = details.get('license_hostid', '') -%}
            {%- endif -%}
            {%- if serial and switch.role is defined -%}
              {%- set _ = assignments.append({
                'fabric': switch.fabric | default(''),
                'hostname': hostname,
                'ip_address': ip,
                'serial_number': serial,
                'role': switch.role
              }) -%}
            {%- endif -%}
          {%- endfor -%}
          {{ assignments }}
      when: switches_to_preprovision is defined and switches_to_preprovision | length > 0
      tags:
        - assign-roles
        - discover-switches

    # Group role assignments by fabric
    - name: Group role assignments by fabric
      ansible.builtin.set_fact:
        roles_by_fabric: |
          {%- set by_fabric = {} -%}
          {%- for sw in switch_role_assignments | default([]) -%}
            {%- set fabric = sw.fabric -%}
            {%- if fabric and fabric not in by_fabric -%}
              {%- set _ = by_fabric.update({fabric: []}) -%}
            {%- endif -%}
            {%- if fabric -%}
              {%- set _ = by_fabric[fabric].append(sw) -%}
            {%- endif -%}
          {%- endfor -%}
          {{ by_fabric }}
      when: switch_role_assignments is defined and switch_role_assignments | length > 0
      tags:
        - assign-roles
        - discover-switches

    - name: Display switch role assignments
      ansible.builtin.debug:
        msg: |
          ═══════════════════════════════════════════════════════════════════════
          SWITCH ROLE ASSIGNMENTS
          ═══════════════════════════════════════════════════════════════════════
          {% for fabric, switches in roles_by_fabric.items() | default([]) %}
          {{ fabric }}:
          {% for sw in switches %}
            - {{ sw.hostname }} ({{ sw.serial_number }}): {{ sw.role }}
          {% endfor %}
          {% endfor %}
          ═══════════════════════════════════════════════════════════════════════
      when: roles_by_fabric is defined and roles_by_fabric | length > 0
      tags:
        - assign-roles
        - discover-switches

    # Assign switch roles via NDFC API
    # API expects array format: [{"role":"aggregation","serialNumber":"..."}]
    - name: Assign switch roles in NDFC
      cisco.nd.nd_rest:
        host: "{{ ansible_host }}"
        username: "{{ ansible_user }}"
        password: "{{ ansible_ssh_pass }}"
        use_ssl: "{{ ansible_httpapi_use_ssl }}"
        validate_certs: "{{ ansible_httpapi_validate_certs }}"
        use_proxy: "{{ ansible_httpapi_use_proxy }}"
        login_domain: "{{ ansible_httpapi_login_domain }}"
        path: "/appcenter/cisco/ndfc/api/v1/lan-fabric/rest/control/switches/roles"
        method: POST
        content: >-
          [{% for sw in item.value %}{"role":"{{ sw.role }}","serialNumber":"{{ sw.serial_number }}"}{% if not loop.last %},{% endif %}{% endfor %}]
      loop: "{{ roles_by_fabric | default({}) | dict2items }}"
      loop_control:
        label: "{{ item.key }} ({{ item.value | length }} switches)"
      when:
        - roles_by_fabric is defined
        - roles_by_fabric | length > 0
      register: role_assignment_results
      ignore_errors: true
      tags:
        - assign-roles
        - discover-switches

    - name: Display role assignment results
      ansible.builtin.debug:
        msg: |
          ═══════════════════════════════════════════════════════════════════════
          ROLE ASSIGNMENT RESULTS
          ═══════════════════════════════════════════════════════════════════════
          {% for result in role_assignment_results.results | default([]) %}
          - {{ result.item.key }}: {{ 'SUCCESS' if not result.failed | default(false) else 'FAILED' }}
            Switches: {% for sw in result.item.value %}{{ sw.hostname }} ({{ sw.role }}){% if not loop.last %}, {% endif %}{% endfor %}
          {% endfor %}
          ═══════════════════════════════════════════════════════════════════════
      when: role_assignment_results is defined
      tags:
        - assign-roles
        - discover-switches

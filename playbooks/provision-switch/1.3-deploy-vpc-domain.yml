---
# Playbook: 1.3-deploy-vpc-domain.yml
# Purpose: Configure and deploy VPC domain to Nexus Dashboard using dcnm_vpc_pair module
#
# Description:
#   This playbook configures VPC domains on aggregation switches by:
#   1. Querying aggregation switches to get IP addresses
#   2. Building VPC pair configuration from J2 template
#   3. Deploying VPC domains via cisco.dcnm.dcnm_vpc_pair module
#
# Variables Required:
#   - vpc_domains: List of VPC domain definitions (from fabric_definitions.yml)
#
# Module Used:
#   - cisco.dcnm.dcnm_vpc_pair: DCNM module for managing VPC switch pairs
#
# Templates Used:
#   - 1.3-deploy-vpc-domain.j2: Jinja2 template for VPC pair configuration
#
# Tags:
#   - deploy-vpc-domain: Run only VPC domain deployment tasks
#
# Example Usage:
#   ansible-playbook ./playbooks/provision-switch/1.3-deploy-vpc-domain.yml

- name: Configure and Deploy VPC Domain in Nexus Dashboard
  hosts: nexus_dashboard
  gather_facts: false

  vars:
    ansible_command_timeout: 300

  tags:
    - deploy-vpc-domain

  tasks:

    # ========================================================================
    # Phase 1: Early exit check
    # ========================================================================

    - name: End play if no VPC domains defined
      ansible.builtin.meta: end_play
      when: vpc_domains | default([]) | length == 0

    # ========================================================================
    # Phase 2: Query switches to get IP addresses
    # ========================================================================

    - name: Query switches in each fabric
      cisco.nd.nd_rest:
        host: "{{ ansible_host }}"
        username: "{{ ansible_user }}"
        password: "{{ ansible_password }}"
        use_ssl: "{{ ansible_httpapi_use_ssl }}"
        validate_certs: "{{ ansible_httpapi_validate_certs }}"
        use_proxy: "{{ ansible_httpapi_use_proxy }}"
        path: "/api/v1/manage/fabrics/{{ item }}/switches?filter=switchRole%3Aaggregation"
        method: GET
      loop: "{{ vpc_domains | map(attribute='FABRIC_NAME') | unique | list }}"
      loop_control:
        label: "{{ item }}"
      register: fabric_switches_query

    - name: Build switch lookup by fabric and hostname
      ansible.builtin.set_fact:
        switch_lookup: |
          {%- set lookup = {} -%}
          {%- for result in fabric_switches_query.results | default([]) -%}
            {%- set fabric = result.item -%}
            {%- if fabric not in lookup -%}
              {%- set _ = lookup.update({fabric: {}}) -%}
            {%- endif -%}
            {%- if result.current is defined and result.current.switches is defined -%}
              {%- for switch in result.current.switches -%}
                {%- set _ = lookup[fabric].update({switch.hostname: {'serial': switch.serialNumber, 'ip': switch.fabricManagementIp}}) -%}
              {%- endfor -%}
            {%- endif -%}
          {%- endfor -%}
          {{ lookup }}

    # ========================================================================
    # Phase 3: Build VPC domain configurations with IP addresses
    # ========================================================================

    - name: Build VPC domain configurations
      ansible.builtin.set_fact:
        vpc_domains_to_deploy: |
          {%- set domains = [] -%}
          {%- for domain in vpc_domains -%}
            {%- set fabric = domain.FABRIC_NAME -%}
            {%- if fabric in switch_lookup -%}
              {%- set fabric_switches = switch_lookup[fabric] -%}
              {%- if domain.PEER1_NAME in fabric_switches and domain.PEER2_NAME in fabric_switches -%}
                {%- set peer1_info = fabric_switches[domain.PEER1_NAME] -%}
                {%- set peer2_info = fabric_switches[domain.PEER2_NAME] -%}
                {%- set updated = domain | combine({
                  'PEER1_IP': peer1_info.ip,
                  'PEER2_IP': peer2_info.ip,
                  'PEER1_SERIAL': peer1_info.serial,
                  'PEER2_SERIAL': peer2_info.serial
                }) -%}
                {%- set _ = domains.append(updated) -%}
              {%- endif -%}
            {%- endif -%}
          {%- endfor -%}
          {{ domains }}

    - name: Display VPC domain deployment plan
      ansible.builtin.debug:
        msg: |
          ═══════════════════════════════════════════════════════════════════════
          VPC DOMAIN DEPLOYMENT PLAN
          ═══════════════════════════════════════════════════════════════════════
          Total defined: {{ vpc_domains | length }}
          To deploy: {{ vpc_domains_to_deploy | length }}
          {% for domain in vpc_domains_to_deploy %}
          - {{ domain.FABRIC_NAME }}: Domain {{ domain.DOMAIN_ID }} ({{ domain.PEER1_NAME }} <-> {{ domain.PEER2_NAME }})
          {% endfor %}
          ═══════════════════════════════════════════════════════════════════════

    # ========================================================================
    # Phase 4: Build VPC configuration from template
    # ========================================================================

    - name: Build VPC pair configuration from template
      ansible.builtin.set_fact:
        vpc_pair_config: "{{ lookup('template', playbook_dir + '/../../templates/1.3-deploy-vpc-domain.j2') | from_json }}"
      when: vpc_domains_to_deploy | length > 0

    - name: Display VPC pairs to configure
      ansible.builtin.debug:
        msg: |
          Configuring {{ vpc_pair_config | length }} VPC pair(s):
          {% for vpc in vpc_pair_config %}
          - Domain {{ vpc.profile.DOMAIN_ID }} on {{ vpc.peerOneId }} <-> {{ vpc.peerTwoId }} (Config Mirroring: {{ vpc.profile.ENABLE_MIRROR_CONFIG }})
          {% endfor %}
      when: vpc_pair_config is defined and vpc_pair_config | length > 0

    # ========================================================================
    # Phase 5: Deploy VPC domain configuration
    # ========================================================================

    - name: Deploy VPC pairs via dcnm_vpc_pair
      cisco.dcnm.dcnm_vpc_pair:
        src_fabric: "{{ vpc_domains_to_deploy[0].FABRIC_NAME }}"
        deploy: true
        state: replaced
        config: "{{ vpc_pair_config }}"
      when: vpc_pair_config is defined and vpc_pair_config | length > 0
      register: vpc_deployment_result

    - name: Display VPC deployment result
      ansible.builtin.debug:
        msg: |
          ═══════════════════════════════════════════════════════════════════════
          VPC DOMAIN DEPLOYMENT RESULT
          ═══════════════════════════════════════════════════════════════════════
          - Changed: {{ vpc_deployment_result.changed | default(false) }}
          - Response: {{ vpc_deployment_result.response | default([]) | length }} operation(s)
          ═══════════════════════════════════════════════════════════════════════
      when: vpc_deployment_result is defined

    # ========================================================================
    # Phase 6: Query and display configured VPC pairs
    # ========================================================================

    - name: Query all configured VPC domains
      cisco.dcnm.dcnm_vpc_pair:
        src_fabric: "{{ vpc_domains_to_deploy[0].FABRIC_NAME }}"
        state: query
        config: []
      register: all_vpc_pairs_query
      when: vpc_domains_to_deploy | length > 0

    - name: Display configured VPC domain details
      ansible.builtin.debug:
        msg: |
          ═══════════════════════════════════════════════════════════════════════
          CONFIGURED VPC DOMAINS
          ═══════════════════════════════════════════════════════════════════════
          Total VPC Domains: {{ all_vpc_pairs_query.response | default([]) | length }}
          {% for vpc in all_vpc_pairs_query.response | default([]) %}
          
          Domain {{ vpc.nvPairs.DOMAIN_ID | default('N/A') }}:
            Fabric: {{ vpc.nvPairs.FABRIC_NAME | default('N/A') }}
            Peer 1: {{ vpc.peerOneId | default('N/A') }}
            Peer 2: {{ vpc.peerTwoId | default('N/A') }}
            PC Mode: {{ vpc.nvPairs.PC_MODE | default('N/A') }}
            Allowed VLANs: {{ vpc.nvPairs.ALLOWED_VLANS | default('N/A') }}
            Config Mirroring: {{ vpc.nvPairs.ENABLE_MIRROR_CONFIG | default('N/A') }}
          {% endfor %}
          ═══════════════════════════════════════════════════════════════════════
      when: all_vpc_pairs_query is defined
---
# Playbook: 1.1-preprovision-features.yml
# Purpose: Configure feature policies on pre-provisioned switches via NDFC
#
# Description:
#   This playbook configures NX-OS feature policies on switches by:
#   1. Loading switch_features.yml to get enabled features per switch
#   2. Loading 1.2-provision-features-feature_lookup.yml to map features to NDFC templates
#   3. Filtering switches with add_to_fabric: true
#   4. Calling the policies/bulk-create API for each mapped feature
#
# Variables Required (per switch in hosts.yml):
#   - add_to_fabric: Set to true to include switch in provisioning
#   - destination_switch_sn: Target switch serial number
#
# Variables from switch_features.yml:
#   - switches.<hostname>.features: List of enabled features
#
# Variables from 1.2-provision-features-feature_lookup.yml:
#   - feature_lookup.<feature>: NDFC template name for the feature
#
# API Endpoints Used:
#   - POST /appcenter/cisco/ndfc/api/v1/lan-fabric/rest/control/policies/bulk-create
#
# Templates Used:
#   - 1.1-provision-features.j2: Jinja2 template for feature policy JSON payload
#
# Tags:
#   - preprovision-features: Run only feature provisioning tasks
#
# Example Usage:
#   ansible-playbook ./playbooks/provision-access/1.1-preprovision-features.yml
#   ansible-playbook ./playbooks/provision-access/1.1-preprovision-features.yml --tags preprovision-features

- name: Configure Feature Policies on Pre-provisioned Switches
  hosts: nexus_dashboard
  gather_facts: false

  tags:
    - preprovision-features

  tasks:

    #--------------------------------------------------------------------------
    # Pre-flight: Verify NDFC is reachable before any provisioning
    #--------------------------------------------------------------------------
    - name: Verify NDFC connectivity
      ansible.builtin.import_tasks: ../common/ndfc-preflight-check.yml

    # Build list of switches to provision features
    - name: Build list of switches to provision
      ansible.builtin.set_fact:
        switches_to_provision: >-
          {{
            groups['switches'] | default([])
            | map('extract', hostvars)
            | selectattr('add_to_fabric', 'defined')
            | selectattr('add_to_fabric', 'equalto', true)
            | list
          }}

    # Build fabric paths from nd_fabrics for targeted file searches
    - name: Build fabric paths from nd_fabrics
      ansible.builtin.import_tasks: ../common/build-fabric-paths.yml
      when: switches_to_provision | length > 0

    - name: Set target fabrics from switches to provision
      ansible.builtin.set_fact:
        target_fabrics: "{{ switches_to_provision | map(attribute='fabric') | select('defined') | list | unique }}"
      when: switches_to_provision | length > 0

    - name: Build target fabric paths
      ansible.builtin.set_fact:
        target_fabric_paths: |
          {%- set out = [] -%}
          {%- for path in fabric_paths | default([]) -%}
            {%- if (path | basename) in (target_fabrics | default([])) -%}
              {%- set _ = out.append(path) -%}
            {%- endif -%}
          {%- endfor -%}
          {{ out }}
      when:
        - switches_to_provision | length > 0
        - target_fabrics is defined
        - target_fabrics | length > 0

    # Load feature lookup table
    - name: Load feature lookup table
      ansible.builtin.include_vars:
        file: "{{ playbook_dir }}/../../templates/1.2-provision-features-feature_lookup.yml"
      when: switches_to_provision | length > 0

    # Load switch features from target fabric only
    - name: Find switch_features.yml in target fabric
      ansible.builtin.find:
        paths: "{{ target_fabric_paths | default([]) }}"
        patterns: "switch_features.yml"
      register: switch_features_files
      when:
        - switches_to_provision | length > 0
        - target_fabric_paths is defined
        - target_fabric_paths | length > 0

    - name: Load switch features data from target fabric
      ansible.builtin.include_vars:
        file: "{{ item.path }}"
        name: "features_data_{{ item.path | dirname | basename }}"
      loop: "{{ switch_features_files.files | default([]) }}"
      loop_control:
        label: "{{ item.path | dirname | basename }}"
      when: switch_features_files is defined

    # Load switch_details.yml to resolve serials when destination_switch_sn is absent
    - name: Find switch_details.yml files in target fabrics
      ansible.builtin.find:
        paths: "{{ target_fabric_paths | default([]) }}"
        patterns: "switch_details.yml"
      register: switch_details_files
      when:
        - switches_to_provision | length > 0
        - target_fabric_paths is defined
        - target_fabric_paths | length > 0

    - name: Load switch details from target fabrics
      ansible.builtin.include_vars:
        file: "{{ item }}"
        name: "switch_details_{{ item | dirname | basename | replace('-', '_') }}"
      loop: "{{ switch_details_files.files | default([]) | map(attribute='path') | list }}"
      loop_control:
        label: "{{ item | dirname | basename }}"
      when: switch_details_files is defined

    - name: Build consolidated switch details lookup (keyed by IP)
      ansible.builtin.set_fact:
        switch_details_lookup: |
          {%- set lookup = {} -%}
          {%- for var_name in hostvars[inventory_hostname] | select('match', '^switch_details_') -%}
            {%- set details = hostvars[inventory_hostname][var_name] -%}
            {%- if details.switches is defined -%}
              {%- for switch in details.switches -%}
                {%- set _ = lookup.update({switch.ip_address: switch}) -%}
              {%- endfor -%}
            {%- endif -%}
          {%- endfor -%}
          {{ lookup }}
      when: switches_to_provision | length > 0

    # Build consolidated switch features lookup
    - name: Build consolidated switch features lookup
      ansible.builtin.set_fact:
        switch_features_lookup: |
          {%- set lookup = {} -%}
          {%- for file in switch_features_files.files | default([]) -%}
            {%- set fabric_name = file.path | dirname | basename -%}
            {%- set var_name = 'features_data_' + fabric_name -%}
            {%- if hostvars[inventory_hostname][var_name] is defined -%}
              {%- set fabric_data = hostvars[inventory_hostname][var_name] -%}
              {%- if fabric_data.switches is defined -%}
                {%- for hostname, data in fabric_data.switches.items() -%}
                  {%- set _ = lookup.update({hostname: data.features | default([])}) -%}
                {%- endfor -%}
              {%- endif -%}
            {%- endif -%}
          {%- endfor -%}
          {{ lookup }}
      when: switches_to_provision | length > 0

    # Build feature policy list for each switch
    - name: Build feature policy configurations
      ansible.builtin.set_fact:
        feature_policies: |
          {%- set policies = [] -%}
          {%- for switch in switches_to_provision -%}
            {%- set hostname = switch.inventory_hostname -%}
            {%- set ip = switch.ansible_host | default('') -%}
            {%- set serial = switch.destination_switch_sn | default('') -%}
            {%- if not serial and switch_details_lookup is defined and ip in switch_details_lookup -%}
              {%- set serial = switch_details_lookup[ip].license_hostid | default('') -%}
            {%- endif -%}
            {%- if serial and hostname in switch_features_lookup -%}
              {%- set features = switch_features_lookup[hostname] -%}
              {%- for feature in features -%}
                {%- if feature in feature_lookup -%}
                  {%- set policy = {
                    'hostname': hostname,
                    'serial_number': serial,
                    'feature': feature,
                    'template_name': feature_lookup[feature]
                  } -%}
                  {%- set _ = policies.append(policy) -%}
                {%- endif -%}
              {%- endfor -%}
            {%- endif -%}
          {%- endfor -%}
          {{ policies }}
      when: switches_to_provision | length > 0

    # Query existing policies per switch to make playbook idempotent
    - name: Get unique serial numbers from feature policies
      ansible.builtin.set_fact:
        unique_serials: "{{ feature_policies | map(attribute='serial_number') | unique | list }}"
      when:
        - feature_policies is defined
        - feature_policies | length > 0

    - name: Query existing policies for each switch
      cisco.nd.nd_rest:
        host: "{{ ansible_host }}"
        username: "{{ ansible_user }}"
        password: "{{ ansible_ssh_pass }}"
        use_ssl: "{{ ansible_httpapi_use_ssl }}"
        validate_certs: "{{ ansible_httpapi_validate_certs }}"
        use_proxy: "{{ ansible_httpapi_use_proxy }}"
        login_domain: "{{ ansible_httpapi_login_domain }}"
        path: "/appcenter/cisco/ndfc/api/v1/lan-fabric/rest/control/policies/switches/{{ item }}"
        method: GET
      loop: "{{ unique_serials | default([]) }}"
      loop_control:
        label: "{{ item }}"
      when:
        - unique_serials is defined
        - unique_serials | length > 0
      register: existing_policies_query
      ignore_errors: true

    - name: Build set of existing policy template names per serial
      ansible.builtin.set_fact:
        existing_policies_lookup: |
          {%- set lookup = {} -%}
          {%- for result in existing_policies_query.results | default([]) -%}
            {%- if result.current is defined and result.current is iterable -%}
              {%- set serial = result.item -%}
              {%- set keys = [] -%}
              {%- for policy in result.current -%}
                {%- if policy.templateName is defined -%}
                  {%- if policy.templateName == 'switch_freeform' and policy.description | default('') != '' -%}
                    {%- set _ = keys.append('switch_freeform:' + policy.description) -%}
                  {%- else -%}
                    {%- set _ = keys.append(policy.templateName) -%}
                  {%- endif -%}
                {%- endif -%}
              {%- endfor -%}
              {%- set _ = lookup.update({serial: keys}) -%}
            {%- endif -%}
          {%- endfor -%}
          {{ lookup }}
      when: existing_policies_query is defined

    - name: Filter out already configured feature policies
      ansible.builtin.set_fact:
        feature_policies_filtered: |
          {%- set filtered = [] -%}
          {%- for policy in feature_policies -%}
            {%- set serial = policy.serial_number -%}
            {%- set existing = existing_policies_lookup.get(serial, []) -%}
            {%- if policy.template_name == 'switch_freeform' -%}
              {%- set key = 'switch_freeform:feature_' + policy.feature -%}
              {%- if key not in existing -%}
                {%- set _ = filtered.append(policy) -%}
              {%- endif -%}
            {%- elif policy.template_name not in existing -%}
              {%- set _ = filtered.append(policy) -%}
            {%- endif -%}
          {%- endfor -%}
          {{ filtered }}
      when:
        - feature_policies is defined
        - existing_policies_lookup is defined

    - name: Display feature policies to configure (after filtering existing)
      ansible.builtin.debug:
        msg: |
          Feature policies to configure (excluding existing): {{ feature_policies_filtered | length }}
          Already configured (skipped): {{ (feature_policies | length) - (feature_policies_filtered | length) }}
          {% set filtered_keys = feature_policies_filtered | map(attribute='hostname') | zip(feature_policies_filtered | map(attribute='feature')) | map('join', ':') | list %}
          {% for policy in feature_policies %}
          {% if (policy.hostname + ':' + policy.feature) not in filtered_keys %}
            (skipped) {{ policy.hostname }}: {{ policy.feature }}
          {% endif %}
          {% endfor %}
          To configure:
          {% for policy in feature_policies_filtered %}
          - {{ policy.hostname }}: {{ policy.feature }} -> {{ policy.template_name }}
          {% endfor %}
      when: feature_policies_filtered is defined

    # Configure feature policies via NDFC API
    - name: Configure feature policies on switches
      cisco.nd.nd_rest:
        host: "{{ ansible_host }}"
        username: "{{ ansible_user }}"
        password: "{{ ansible_ssh_pass }}"
        use_ssl: "{{ ansible_httpapi_use_ssl }}"
        validate_certs: "{{ ansible_httpapi_validate_certs }}"
        use_proxy: "{{ ansible_httpapi_use_proxy }}"
        login_domain: "{{ ansible_httpapi_login_domain }}"
        path: "/appcenter/cisco/ndfc/api/v1/lan-fabric/rest/control/policies/bulk-create"
        method: POST
        content: "{{ lookup('template', '../../templates/1.2-provision-features.j2') }}"
      loop: "{{ feature_policies_filtered }}"
      loop_control:
        label: "{{ item.hostname }}: {{ item.feature }}"
      vars:
        serial_number: "{{ item.serial_number }}"
        template_name: "{{ item.template_name }}"
        feature: "{{ item.feature }}"
      when:
        - feature_policies_filtered is defined
        - feature_policies_filtered | length > 0
      register: feature_policy_results

    - name: Display feature policy configuration results
      ansible.builtin.debug:
        msg: |
          Feature policy configuration complete.
          Already existed (skipped): {{ (feature_policies | length) - (feature_policies_filtered | default([]) | length) }}
          {% for result in feature_policy_results.results | default([]) %}
          {% if result.skipped is not defined or not result.skipped %}
          - {{ result.item.hostname }}/{{ result.item.feature }}: {{ 'SUCCESS' if result.failed is not defined or not result.failed else 'FAILED' }}
          {% endif %}
          {% endfor %}
      when: feature_policy_results is defined

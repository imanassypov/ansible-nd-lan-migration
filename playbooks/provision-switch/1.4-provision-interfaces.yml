---
#==============================================================================
# Playbook: Configure Interfaces in Nexus Dashboard Fabric Controller (NDFC)
#==============================================================================
# Purpose: Deploy Layer 2 and VPC interface configurations to NDFC
#          for the target fabric using profiled interface inventory data
#
# Module: cisco.dcnm.dcnm_interface
#   - Provides declarative state management (merged/replaced)
#   - Automatically handles create vs update (idempotent)
#   - Supports Ethernet, Port-channel, and VPC interface types
#
# Prerequisites:
#   - Interface inventory files generated by 1.0-profile-existing-switches.yml
#   - NDFC fabric must already be created and switches added
#   - VPC domains must be configured (for VPC interface deployment)
#
# Inventory Files Used:
#   - fabrics/<fabric>/l2_interfaces.yml - Non-VPC L2 interface configurations
#   - fabrics/<fabric>/l2_vpc_interfaces.yml - VPC interface configurations
#
# Tags:
#   - deploy-l2-interfaces: Deploy only Layer 2 interfaces
#   - deploy-vpc-interfaces: Deploy only VPC interfaces
#
# Usage Examples:
#   ansible-playbook 1.4-provision-interfaces.yml --tags deploy-l2-interfaces
#   ansible-playbook 1.4-provision-interfaces.yml --tags deploy-vpc-interfaces
#   ansible-playbook 1.4-provision-interfaces.yml  # Deploy all interface types
#==============================================================================

#------------------------------------------------------------------------------
# Play 1: Configure Layer 2 Interfaces (Ethernet and Port-channels)
#------------------------------------------------------------------------------
# Uses dcnm_interface module with state=replaced for idempotent configuration
# - Automatically creates new interfaces
# - Updates existing interfaces if configuration differs
# - Deploys configuration to switches
#------------------------------------------------------------------------------
- name: Configure Layer 2 Interfaces in NDFC
  hosts: nexus_dashboard
  gather_facts: false
  tags: deploy-l2-interfaces

  tasks:
    #--------------------------------------------------------------------------
    # Setup: Build list of switches to provision
    #--------------------------------------------------------------------------
    - name: Build list of switches to provision
      ansible.builtin.set_fact:
        switches_to_provision: >-
          {{
            groups['switches'] | default([])
            | map('extract', hostvars)
            | selectattr('add_to_fabric', 'defined')
            | selectattr('add_to_fabric', 'equalto', true)
            | list
          }}

    - name: Display switches to provision
      ansible.builtin.debug:
        msg: "Provisioning {{ switches_to_provision | length }} switch(es): {{ switches_to_provision | map(attribute='inventory_hostname') | list }}"
      when: switches_to_provision | length > 0

    #--------------------------------------------------------------------------
    # Load L2 interface inventory from fabric directories
    #--------------------------------------------------------------------------
    - name: Find all l2_interfaces.yml files
      ansible.builtin.find:
        paths: "{{ playbook_dir }}/../../fabrics"
        patterns: "l2_interfaces.yml"
        recurse: true
      register: l2_interfaces_files
      when: switches_to_provision | length > 0

    - name: Load L2 interfaces data from all fabrics
      ansible.builtin.include_vars:
        file: "{{ item.path }}"
        name: "l2_data_{{ item.path | dirname | basename }}"
      loop: "{{ l2_interfaces_files.files | default([]) }}"
      loop_control:
        label: "{{ item.path | dirname | basename }}"
      when: switches_to_provision | length > 0

    #--------------------------------------------------------------------------
    # Build consolidated L2 interfaces lookup
    #--------------------------------------------------------------------------
    - name: Build consolidated L2 interfaces lookup
      ansible.builtin.set_fact:
        l2_interfaces_lookup: >-
          {%- set lookup = {} -%}
          {%- for file in l2_interfaces_files.files | default([]) -%}
            {%- set fabric_name = file.path | dirname | basename -%}
            {%- set var_name = 'l2_data_' + fabric_name -%}
            {%- if hostvars[inventory_hostname][var_name] is defined -%}
              {%- set fabric_data = hostvars[inventory_hostname][var_name] -%}
              {%- if fabric_data.switches is defined -%}
                {%- for hostname, data in fabric_data.switches.items() -%}
                  {%- set _ = lookup.update({hostname: {'interfaces': data.interfaces | default([]), 'fabric': fabric_name}}) -%}
                {%- endfor -%}
              {%- endif -%}
            {%- endif -%}
          {%- endfor -%}
          {{ lookup }}
      when: switches_to_provision | length > 0

    #--------------------------------------------------------------------------
    # Configure Ethernet Interfaces using dcnm_interface module
    #--------------------------------------------------------------------------
    - name: Build Ethernet interface configuration for dcnm_interface
      ansible.builtin.set_fact:
        eth_interface_config: >-
          {%- set config = [] -%}
          {%- for switch in switches_to_provision -%}
            {%- set switch_name = switch.inventory_hostname -%}
            {%- if switch_name in l2_interfaces_lookup -%}
              {%- set switch_ip = hostvars[switch_name]['ansible_host'] -%}
              {%- set eth_interfaces = l2_interfaces_lookup[switch_name].interfaces | selectattr('type', 'equalto', 'eth') | list -%}
              {%- for iface in eth_interfaces -%}
                {%- set iface_name = iface.name | regex_replace('^Ethernet', 'eth') -%}
                {%- set iface_config = {
                  'name': iface_name,
                  'type': 'eth',
                  'switch': [switch_ip],
                  'deploy': true,
                  'profile': {
                    'admin_state': true,
                    'mode': iface.mode,
                    'description': iface.description | default('')
                  }
                } -%}
                {%- if iface.mode == 'trunk' -%}
                  {%- set _ = iface_config.profile.update({
                    'allowed_vlans': iface.trunk.allowed_vlans | default('none'),
                    'native_vlan': iface.trunk.native_vlan | default('') | string,
                    'bpdu_guard': 'true',
                    'port_type_fast': true
                  }) -%}
                {%- elif iface.mode == 'access' -%}
                  {%- set _ = iface_config.profile.update({
                    'access_vlan': iface.access.vlan | default('') | string,
                    'bpdu_guard': 'true',
                    'port_type_fast': true
                  }) -%}
                {%- endif -%}
                {%- set _ = config.append(iface_config) -%}
              {%- endfor -%}
            {%- endif -%}
          {%- endfor -%}
          {{ config }}
      when:
        - switches_to_provision | length > 0
        - l2_interfaces_lookup is defined

    - name: Display Ethernet interfaces to configure
      ansible.builtin.debug:
        msg: "Configuring {{ eth_interface_config | length }} Ethernet interface(s)"
      when: eth_interface_config is defined and eth_interface_config | length > 0

    - name: Configure Ethernet interfaces via dcnm_interface
      cisco.dcnm.dcnm_interface:
        fabric: "{{ hostvars[switches_to_provision[0].inventory_hostname]['fabric'] }}"
        state: replaced
        check_deploy: true
        config: "{{ eth_interface_config }}"
      when:
        - switches_to_provision | length > 0
        - eth_interface_config is defined
        - eth_interface_config | length > 0
      register: eth_deploy_result

    - name: Display Ethernet interface deployment result
      ansible.builtin.debug:
        msg: |
          Ethernet Interface Deployment Result:
          - Changed: {{ eth_deploy_result.changed | default(false) }}
          - Response: {{ eth_deploy_result.response | default([]) | length }} operation(s)
      when: eth_deploy_result is defined

    #--------------------------------------------------------------------------
    # Configure Port-channel Interfaces using dcnm_interface module
    #--------------------------------------------------------------------------
    - name: Build Port-channel interface configuration for dcnm_interface
      ansible.builtin.set_fact:
        pc_interface_config: >-
          {%- set config = [] -%}
          {%- for switch in switches_to_provision -%}
            {%- set switch_name = switch.inventory_hostname -%}
            {%- if switch_name in l2_interfaces_lookup -%}
              {%- set switch_ip = hostvars[switch_name]['ansible_host'] -%}
              {%- set pc_interfaces = l2_interfaces_lookup[switch_name].interfaces | selectattr('type', 'equalto', 'pc') | list -%}
              {%- for iface in pc_interfaces -%}
                {%- set pc_id = iface.name | regex_replace('^port-channel', '') -%}
                {%- set iface_name = 'po' + pc_id -%}
                {%- set members = [] -%}
                {%- if iface.members is defined -%}
                  {%- for member in iface.members -%}
                    {%- set member_name = member.interface | regex_replace('^Ethernet', 'e') -%}
                    {%- set _ = members.append(member_name) -%}
                  {%- endfor -%}
                {%- endif -%}
                {%- set iface_config = {
                  'name': iface_name,
                  'type': 'pc',
                  'switch': [switch_ip],
                  'deploy': true,
                  'profile': {
                    'admin_state': true,
                    'mode': iface.mode,
                    'members': members,
                    'pc_mode': 'active',
                    'bpdu_guard': 'true',
                    'port_type_fast': true,
                    'mtu': 'jumbo',
                    'description': iface.description | default('')
                  }
                } -%}
                {%- if iface.mode == 'trunk' -%}
                  {%- set _ = iface_config.profile.update({
                    'allowed_vlans': iface.trunk.allowed_vlans | default('none'),
                    'native_vlan': iface.trunk.native_vlan | default('') | string
                  }) -%}
                {%- elif iface.mode == 'access' -%}
                  {%- set _ = iface_config.profile.update({
                    'access_vlan': iface.access.vlan | default('') | string
                  }) -%}
                {%- endif -%}
                {%- set _ = config.append(iface_config) -%}
              {%- endfor -%}
            {%- endif -%}
          {%- endfor -%}
          {{ config }}
      when:
        - switches_to_provision | length > 0
        - l2_interfaces_lookup is defined

    - name: Display Port-channel interfaces to configure
      ansible.builtin.debug:
        msg: "Configuring {{ pc_interface_config | length }} Port-channel interface(s)"
      when: pc_interface_config is defined and pc_interface_config | length > 0

    - name: Configure Port-channel interfaces via dcnm_interface
      cisco.dcnm.dcnm_interface:
        fabric: "{{ hostvars[switches_to_provision[0].inventory_hostname]['fabric'] }}"
        state: replaced
        check_deploy: true
        config: "{{ pc_interface_config }}"
      when:
        - switches_to_provision | length > 0
        - pc_interface_config is defined
        - pc_interface_config | length > 0
      register: pc_deploy_result

    - name: Display Port-channel interface deployment result
      ansible.builtin.debug:
        msg: |
          Port-channel Interface Deployment Result:
          - Changed: {{ pc_deploy_result.changed | default(false) }}
          - Response: {{ pc_deploy_result.response | default([]) | length }} operation(s)
      when: pc_deploy_result is defined


#------------------------------------------------------------------------------
# Play 2: Configure VPC Interfaces
#------------------------------------------------------------------------------
# Uses dcnm_interface module with state=replaced for idempotent VPC config
# - VPC interfaces span two switches (peer1 and peer2)
# - Automatically creates or updates VPC interface configuration
# - VPC domain must be configured before deploying VPC interfaces
#------------------------------------------------------------------------------
- name: Configure VPC Interfaces in NDFC
  hosts: nexus_dashboard
  gather_facts: false
  tags: deploy-vpc-interfaces

  tasks:
    #--------------------------------------------------------------------------
    # Setup: Build list of switches to provision
    #--------------------------------------------------------------------------
    - name: Build list of switches to provision
      ansible.builtin.set_fact:
        switches_to_provision: >-
          {{
            groups['switches'] | default([])
            | map('extract', hostvars)
            | selectattr('add_to_fabric', 'defined')
            | selectattr('add_to_fabric', 'equalto', true)
            | list
          }}

    #--------------------------------------------------------------------------
    # Load VPC interface inventory from fabric directories
    #--------------------------------------------------------------------------
    - name: Find all l2_vpc_interfaces.yml files
      ansible.builtin.find:
        paths: "{{ playbook_dir }}/../../fabrics"
        patterns: "l2_vpc_interfaces.yml"
        recurse: true
      register: vpc_interfaces_files
      when: switches_to_provision | length > 0

    - name: Load VPC interfaces data from all fabrics
      ansible.builtin.include_vars:
        file: "{{ item.path }}"
        name: "vpc_data_{{ item.path | dirname | basename }}"
      loop: "{{ vpc_interfaces_files.files | default([]) }}"
      loop_control:
        label: "{{ item.path | dirname | basename }}"
      when: switches_to_provision | length > 0

    #--------------------------------------------------------------------------
    # Build consolidated VPC interfaces lookup (per fabric)
    #--------------------------------------------------------------------------
    - name: Build consolidated VPC interfaces lookup
      ansible.builtin.set_fact:
        vpc_interfaces_by_fabric: >-
          {%- set lookup = {} -%}
          {%- for file in vpc_interfaces_files.files | default([]) -%}
            {%- set fabric_name = file.path | dirname | basename -%}
            {%- set var_name = 'vpc_data_' + fabric_name -%}
            {%- if hostvars[inventory_hostname][var_name] is defined -%}
              {%- set vpc_data = hostvars[inventory_hostname][var_name] -%}
              {%- if vpc_data.vpc_interfaces is defined -%}
                {%- set _ = lookup.update({fabric_name: vpc_data.vpc_interfaces}) -%}
              {%- endif -%}
            {%- endif -%}
          {%- endfor -%}
          {{ lookup }}
      when: switches_to_provision | length > 0

    - name: Get unique fabrics from switches to provision
      ansible.builtin.set_fact:
        fabrics_to_process: "{{ switches_to_provision | map(attribute='fabric') | unique | list }}"
      when: switches_to_provision | length > 0

    #--------------------------------------------------------------------------
    # Build VPC interface configuration for dcnm_interface module
    #--------------------------------------------------------------------------
    - name: Build VPC interface configuration for dcnm_interface
      ansible.builtin.set_fact:
        vpc_interface_config: >-
          {%- set config = [] -%}
          {%- for fabric_name in fabrics_to_process | default([]) -%}
            {%- if fabric_name in vpc_interfaces_by_fabric -%}
              {%- for vpc in vpc_interfaces_by_fabric[fabric_name] -%}
                {%- set peer1_name = vpc.switches[0] -%}
                {%- set peer2_name = vpc.switches[1] -%}
                {%- set peer1_ip = hostvars[peer1_name]['ansible_host'] -%}
                {%- set peer2_ip = hostvars[peer2_name]['ansible_host'] -%}
                {%- set peer1_members = [] -%}
                {%- set peer2_members = [] -%}
                {%- if vpc.members is defined -%}
                  {%- if peer1_name in vpc.members -%}
                    {%- for member in vpc.members[peer1_name] -%}
                      {%- set member_name = member.interface | regex_replace('^Ethernet', 'e') -%}
                      {%- set _ = peer1_members.append(member_name) -%}
                    {%- endfor -%}
                  {%- endif -%}
                  {%- if peer2_name in vpc.members -%}
                    {%- for member in vpc.members[peer2_name] -%}
                      {%- set member_name = member.interface | regex_replace('^Ethernet', 'e') -%}
                      {%- set _ = peer2_members.append(member_name) -%}
                    {%- endfor -%}
                  {%- endif -%}
                {%- endif -%}
                {%- set vpc_name = 'vpc' + vpc.vpc_id | string -%}
                {%- set vpc_config = {
                  'name': vpc_name,
                  'type': 'vpc',
                  'switch': [[peer1_ip, peer2_ip]],
                  'deploy': true,
                  'profile': {
                    'admin_state': true,
                    'mode': vpc.mode,
                    'peer1_pcid': vpc.vpc_id,
                    'peer2_pcid': vpc.vpc_id,
                    'peer1_members': peer1_members,
                    'peer2_members': peer2_members,
                    'pc_mode': 'active',
                    'bpdu_guard': 'true',
                    'port_type_fast': true,
                    'mtu': 'jumbo'
                  }
                } -%}
                {%- if vpc.mode == 'trunk' -%}
                  {%- set _ = vpc_config.profile.update({
                    'peer1_allowed_vlans': vpc.trunk.allowed_vlans | default('none'),
                    'peer2_allowed_vlans': vpc.trunk.allowed_vlans | default('none'),
                    'peer1_native_vlan': vpc.trunk.native_vlan | default('') | string,
                    'peer2_native_vlan': vpc.trunk.native_vlan | default('') | string,
                    'peer1_description': vpc.description | default('VPC ' + vpc.vpc_id | string + ' trunk'),
                    'peer2_description': vpc.description | default('VPC ' + vpc.vpc_id | string + ' trunk')
                  }) -%}
                {%- elif vpc.mode == 'access' -%}
                  {%- set _ = vpc_config.profile.update({
                    'peer1_access_vlan': vpc.access.vlan | default('') | string,
                    'peer2_access_vlan': vpc.access.vlan | default('') | string,
                    'peer1_description': vpc.description | default('VPC ' + vpc.vpc_id | string + ' access'),
                    'peer2_description': vpc.description | default('VPC ' + vpc.vpc_id | string + ' access')
                  }) -%}
                {%- endif -%}
                {%- set _ = config.append(vpc_config) -%}
              {%- endfor -%}
            {%- endif -%}
          {%- endfor -%}
          {{ config }}
      when:
        - switches_to_provision | length > 0
        - vpc_interfaces_by_fabric is defined
        - fabrics_to_process is defined

    - name: Display VPC interfaces to configure
      ansible.builtin.debug:
        msg: |
          Configuring {{ vpc_interface_config | length }} VPC interface(s):
          {% for vpc in vpc_interface_config %}
          - {{ vpc.name }}: {{ vpc.profile.mode }} mode, peers {{ vpc.switch[0] }}
          {% endfor %}
      when: vpc_interface_config is defined and vpc_interface_config | length > 0

    #--------------------------------------------------------------------------
    # Configure VPC Interfaces using dcnm_interface module
    #--------------------------------------------------------------------------
    - name: Configure VPC interfaces via dcnm_interface
      cisco.dcnm.dcnm_interface:
        fabric: "{{ fabrics_to_process[0] }}"
        state: replaced
        check_deploy: true
        config: "{{ vpc_interface_config }}"
      when:
        - switches_to_provision | length > 0
        - vpc_interface_config is defined
        - vpc_interface_config | length > 0
        - fabrics_to_process | length > 0
      register: vpc_deploy_result

    - name: Display VPC interface deployment result
      ansible.builtin.debug:
        msg: |
          VPC Interface Deployment Result:
          - Changed: {{ vpc_deploy_result.changed | default(false) }}
          - Response: {{ vpc_deploy_result.response | default([]) | length }} operation(s)
          {% if vpc_deploy_result.diff is defined %}
          - Diff: {{ vpc_deploy_result.diff | length }} difference(s) detected
          {% endif %}
      when: vpc_deploy_result is defined

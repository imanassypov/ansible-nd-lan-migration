{#
================================================================================
Template: VPC Domain Configuration for dcnm_vpc_pair Module
================================================================================
Purpose:
  Generate VPC pair configuration list for the cisco.dcnm.dcnm_vpc_pair
  module to deploy VPC domains to NDFC.

Module: cisco.dcnm.dcnm_vpc_pair
  - state: merged (idempotent configuration)
  - deploy: true (push config to switches)

Input Variables:
  vpc_domains_to_deploy  - List of VPC domain definitions with IP addresses

VPC Domain Settings (from fabric_definitions.yml):
  - DOMAIN_ID: VPC domain ID (1-1000)
  - PEER1_NAME / PEER2_NAME: Switch hostnames
  - PEER1_KEEP_ALIVE_LOCAL_IP / PEER2_KEEP_ALIVE_LOCAL_IP: Keepalive source IPs
  - KEEPALIVE_VRF: VRF for keepalive messages
  - PEER1_PCID / PEER2_PCID: Peer-link port-channel IDs
  - PEER1_MEMBER_INTERFACES / PEER2_MEMBER_INTERFACES: Peer-link member interfaces
  - ALLOWED_VLANS: VLANs allowed on peer-link

Output:
  List of VPC pair configurations in dcnm_vpc_pair format

================================================================================
#}
{% set config = [] %}
{% for domain in vpc_domains_to_deploy %}
  {% set peer1_members = domain.PEER1_MEMBER_INTERFACES | default([]) | map('regex_replace', '^Ethernet', 'e') | join(',') %}
  {% set peer2_members = domain.PEER2_MEMBER_INTERFACES | default([]) | map('regex_replace', '^Ethernet', 'e') | join(',') %}
  {% set vpc_config = {
    'peerOneId': domain.PEER1_IP,
    'peerTwoId': domain.PEER2_IP,
    'templateName': 'vpc_pair',
    'profile': {
      'ADMIN_STATE': true,
      'DOMAIN_ID': domain.DOMAIN_ID | int,
      'FABRIC_NAME': domain.FABRIC_NAME,
      'KEEP_ALIVE_VRF': domain.KEEPALIVE_VRF | default('management'),
      'KEEP_ALIVE_HOLD_TIMEOUT': domain.KEEP_ALIVE_HOLD_TIMEOUT | default(3) | int,
      'PC_MODE': domain.PC_MODE | default('active'),
      'PEER1_KEEP_ALIVE_LOCAL_IP': domain.PEER1_KEEP_ALIVE_LOCAL_IP,
      'PEER2_KEEP_ALIVE_LOCAL_IP': domain.PEER2_KEEP_ALIVE_LOCAL_IP,
      'PEER1_MEMBER_INTERFACES': peer1_members,
      'PEER2_MEMBER_INTERFACES': peer2_members,
      'PEER1_PCID': domain.PEER1_PCID | default(1) | int,
      'PEER2_PCID': domain.PEER2_PCID | default(1) | int,
      'PEER1_PO_DESC': domain.PEER1_PC_DESCRIPTION | default('VPC Peer-Link'),
      'PEER2_PO_DESC': domain.PEER2_PC_DESCRIPTION | default('VPC Peer-Link'),
      'ALLOWED_VLANS': domain.ALLOWED_VLANS | default('all'),
      'ENABLE_MIRROR_CONFIG': domain.ENABLE_MIRROR_CONFIG | default(true)
    }
  } %}
  {% set _ = config.append(vpc_config) %}
{% endfor %}
{{ config | to_json }}

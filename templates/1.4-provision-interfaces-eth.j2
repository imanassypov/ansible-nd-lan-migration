{#
================================================================================
Template: Ethernet Interface Configuration for dcnm_interface Module
================================================================================
Purpose:
  Generate Ethernet interface configuration list for the cisco.dcnm.dcnm_interface
  module to deploy L2 access and trunk interfaces to NDFC.

Module: cisco.dcnm.dcnm_interface
  - type: eth (Ethernet interface)
  - state: replaced (idempotent configuration)

Input Variables:
  switches_to_provision      - List of switches with add_to_fabric: true
  l2_interfaces_lookup       - Consolidated interface data per switch

Output:
  List of Ethernet interface configurations in dcnm_interface format

Interface Naming:
  - Input: Ethernet1/3
  - Output: eth1/3 (dcnm_interface format)

Supported Modes:
  - access: Single VLAN access port with BPDU guard
  - trunk: Multiple VLANs with native VLAN and BPDU guard

Port-channel Member Auto-extraction:
  Member interfaces defined inside port-channel (type: pc) definitions are
  automatically extracted and provisioned as trunk Ethernet interfaces.
  This ensures member ports exist in NDFC before the port-channel references them.
  Discovery excludes members from standalone eth list to avoid duplication,
  so this template re-creates them from the port-channel member definitions.

================================================================================
#}
{% set config = [] %}
{% for switch in switches_to_provision %}
  {% set switch_name = switch.inventory_hostname %}
  {% if switch_name in l2_interfaces_lookup %}
    {% set switch_ip = hostvars[switch_name]['ansible_host'] %}
    {# --- Auto-extract port-channel member interfaces --- #}
    {% set pc_interfaces = l2_interfaces_lookup[switch_name].interfaces | selectattr('type', 'equalto', 'pc') | list %}
    {% for pc in pc_interfaces %}
      {% if pc.members is defined %}
        {% for member in pc.members %}
          {% set member_iface_name = member.interface | regex_replace('^Ethernet', 'eth') %}
          {% set member_config = {
            'name': member_iface_name,
            'type': 'eth',
            'switch': [switch_ip],
            'deploy': false,
            'profile': {
              'admin_state': pc.enabled | default(true),
              'mode': pc.mode | default('trunk'),
              'bpdu_guard': 'true',
              'port_type_fast': true,
              'description': (pc.description | default('')) ~ ' member'
            }
          } %}
          {% if pc.mode | default('trunk') == 'trunk' %}
            {% set _ = member_config.profile.update({
              'allowed_vlans': pc.trunk.allowed_vlans | default('all'),
              'native_vlan': pc.trunk.native_vlan | default('') | string
            }) %}
          {% elif pc.mode | default('trunk') == 'access' %}
            {% set _ = member_config.profile.update({
              'access_vlan': pc.access.vlan | default('') | string
            }) %}
          {% endif %}
          {% set _ = config.append(member_config) %}
        {% endfor %}
      {% endif %}
    {% endfor %}
    {# --- Standard Ethernet interfaces --- #}
    {% set eth_interfaces = l2_interfaces_lookup[switch_name].interfaces | selectattr('type', 'equalto', 'eth') | list %}
    {% for iface in eth_interfaces %}
      {# Only process interfaces that have explicit mode configuration #}
      {% if iface.mode is defined %}
      {% set iface_name = iface.name | regex_replace('^Ethernet', 'eth') %}
      {% set iface_config = {
        'name': iface_name,
        'type': 'eth',
        'switch': [switch_ip],
        'deploy': false,
        'profile': {
          'admin_state': iface.enabled | default(true),
          'mode': iface.mode,
          'description': iface.description | default('')
        }
      } %}
      {% if iface.mode == 'trunk' %}
        {% set _ = iface_config.profile.update({
          'allowed_vlans': iface.trunk.allowed_vlans | default('all'),
          'native_vlan': iface.trunk.native_vlan | default('') | string,
          'bpdu_guard': 'true',
          'port_type_fast': true
        }) %}
      {% elif iface.mode == 'access' %}
        {% set _ = iface_config.profile.update({
          'access_vlan': iface.access.vlan | default('') | string,
          'bpdu_guard': 'true',
          'port_type_fast': true
        }) %}
      {% endif %}
      {% set _ = config.append(iface_config) %}
      {% endif %}
    {% endfor %}
  {% endif %}
{% endfor %}
{{ config | to_json }}

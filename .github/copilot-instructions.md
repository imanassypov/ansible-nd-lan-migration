# Copilot Instructions: Ansible DC LAN Migration

## Architecture Overview

Ansible automation migrating Cisco NX-OS switches from CLI to **Nexus Dashboard Fabric Controller (NDFC)**, plus POAP pre-provisioning for new switches.

### Data Flow
```
inventory/hosts.yml              → Switch definitions (fabric, role, add_to_fabric)
fabric_definitions.yml           → Source of truth: nd_fabrics[], vpc_domains[]
discovery/1.0-profile-*.yml      → SSH to switches → generates fabrics/<fabric>/*.yml
templates/*.j2                   → Transform YAML → NDFC API payloads
provision-switch/1.x-*.yml       → Deploy via NDFC httpapi
```

### Playbook Sequence (`0.0-full-provision-switch.yml` runs all)
| Playbook | Purpose | Key Tags |
|----------|---------|----------|
| 1.0-provision-switches | POAP/discovery | `preprovision-switches`, `discover-switches` |
| 1.4-provision-interfaces | L2/VPC/SVI | `deploy-l2-interfaces`, `deploy-vpc-interfaces`, `deploy-svi-interfaces` |

### Discovery Tags (`1.0-profile-existing-switches.yml`)
`profile-switches` → `switch_details.yml` | `profile-vlans` → `vlan_database.yml` | `profile-l2-interfaces` → `l2_interfaces.yml`, `l2_vpc_interfaces.yml`

## Connection Patterns (NEVER Mix!)

| Target | `hosts:` | Connection | Collection |
|--------|----------|------------|------------|
| NX-OS Switches | `switches` | `ansible.netcommon.network_cli` | `cisco.nxos` |
| Nexus Dashboard | `nexus_dashboard` | `ansible.netcommon.httpapi` | `cisco.nd`, `cisco.dcnm` |

**Credentials**: `vault_switch_password` (switches), `vault_nd_password` (ND) in `inventory/group_vars/all/vault.yml`

## Development Commands

```bash
# Setup (Python 3.13+ required, use UV only - never pip)
uv sync && source .venv/bin/activate
ansible-galaxy collection install -r requirements.yml

# Vault
echo "password" > .vault_pass && ansible-vault edit inventory/group_vars/all/vault.yml

# Run examples
ansible-playbook playbooks/provision-switch/0.0-full-provision-switch.yml -v
ansible-playbook playbooks/provision-switch/1.4-provision-interfaces.yml --tags deploy-vpc-interfaces
ansible-playbook playbooks/discovery/1.0-profile-existing-switches.yml --tags profile-vlans
```

## Critical Patterns

### Switch Filtering (required in every provision playbook)
```yaml
switches_to_provision: >-
  {{ groups['switches'] | map('extract', hostvars)
     | selectattr('add_to_fabric', 'defined')
     | selectattr('add_to_fabric', 'equalto', true) | list }}
```

### Interface Naming Transforms (Jinja2 templates)
```jinja2
port-channel113 → vpc113           {# VPC dcnm_interface format #}
Ethernet1/4 → e1/4                 {# regex_replace('^Ethernet', 'e') #}
```

### Loading Fabric Data
```yaml
- find:
    paths: "{{ playbook_dir }}/../../fabrics"
    patterns: "l2_interfaces.yml"
    recurse: true
  register: interface_files

- include_vars:
    file: "{{ item.path }}"
    name: "data_{{ item.path | dirname | basename }}"  # Namespace by fabric
  loop: "{{ interface_files.files }}"
```

### hosts.yml Switch Structure
```yaml
switch_name:
  ansible_host: 198.18.24.81
  fabric: mgmt-fabric              # Must match nd_fabrics[].FABRIC_NAME
  role: access                     # access | aggregation
  add_to_fabric: true              # false = excluded from provisioning
  mgmt_int: Vlan199
  # POAP only (new switches):
  destination_switch_sn: ABC123
  destination_switch_model: N9K-C9300v
  destination_switch_version: "10.6(1)"
```

## Template Conventions

Templates are numbered to match playbooks (`1.4-provision-interfaces-*.j2` for `1.4-provision-interfaces.yml`):
- Templates read from `fabrics/<fabric>/*.yml` (generated by discovery)
- Output NDFC-compatible payloads consumed via `| from_json` filter
- **VPC ID 1 is ALWAYS skipped** — reserved for VPC peer-link in `vpc_domains[]`

## Key Files Reference

| File | Purpose |
|------|---------|
| `inventory/host_vars/nexus_dashboard/fabric_definitions.yml` | Fabric + VPC domain source of truth |
| `inventory/group_vars/nd/connection.yml` | NDFC timeout settings (`ansible_command_timeout: 1000`) |
| `templates/feature_lookup.yml` | NX-OS feature → NDFC template name mapping |
| `fabrics/<fabric>/*.yml` | Discovery output (auto-generated, do not edit manually) |

## Adding New Switches

1. Add to `inventory/hosts.yml` under `switches.children.access` or `switches.children.aggegation`
2. Set `add_to_fabric: true`
3. For POAP: include `destination_switch_sn`, `destination_switch_model`, `destination_switch_version`
4. For existing switches: run discovery first with `--tags profile-switches,profile-vlans,...`

## Debugging

- **Retry files**: `retry/*.retry` lists failed hosts from previous runs
- **Template debugging**: Add `| to_nice_json` to inspect generated payloads
- **NDFC API testing**: Use `scripts/dry-run-ndfc-api.sh`
- **Connection timeouts**: Check `ansible_command_timeout: 1000` in `inventory/group_vars/nd/connection.yml`
